#!/usr/bin/env bash

set -o errexit
set -o nounset

# https://www.debian.org/doc/manuals/maint-guide/first.en.html#namever
VERSION=$(sed 's|-|~|; s/^v//' dist/VERSION)
PACKAGE_NAME="go-config-yourself"
PACKAGE_LOCATION="dist/${PACKAGE_NAME}_${VERSION}"
PACKAGE_URL="https://github.com/blinkhealth/go-config-yourself"

mkdir -p "${PACKAGE_LOCATION}/usr/local/bin"
mkdir -p "${PACKAGE_LOCATION}/DEBIAN"

cp dist/gcy-linux-amd64 "${PACKAGE_LOCATION}/usr/local/bin/gcy"
cp dist/docs/man/* "${PACKAGE_LOCATION}/"
cp LICENSE "${PACKAGE_LOCATION}/DEBIAN/copyright"

find dist/docs/man/go-* -type f -exec basename {} \; > "${PACKAGE_LOCATION}/DEBIAN/manpages"

cat >"${PACKAGE_LOCATION}/DEBIAN/control" <<-EOF
Package: ${PACKAGE_NAME}
Version: ${VERSION}
Standards-Version: 3.9.6
Section: utils
Architecture: any-amd64
Maintainer: Blink Health Engineering <opensource@blinkhealth.com>
Description: A CLI tool and language-specific runtimes to deal with everyday application configuration in your repository.
   The command line tool is an installable binary written in go that enables a developer to work with encrypted values in config files.
Homepage: https://blinkhealth.github.com/go-config-yourself
Vcs-Git: ${PACKAGE_URL}.git
Vcs-Browser: ${PACKAGE_URL}
EOF

dpkg-deb --build "$PACKAGE_LOCATION" | tee debuild.log

branch="stable"
if [[ "$VERSION" == *~* ]]; then
    branch="unstable"
fi

>&2 echo "Debian publishing disabled!"
echo dput ppa:blinkhealth/${branch} "$(perl -ne 'print $1 if /dpkg-genchanges -S >(.*)/' debuild.log)"
exit 2

# dput ppa:blinkhealth/${branch} "$(perl -ne 'print $1 if /dpkg-genchanges -S >(.*)/' debuild.log)"
